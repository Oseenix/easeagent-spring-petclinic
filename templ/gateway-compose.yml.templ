version: '3'

services:
  config-server:
    image: springcommunity/spring-petclinic-config-server
    container_name: config-server
    volumes:
      - ${SCRIPTPATH}/spring-petclinic-microservices-config:/git-repo
    environment:
      - GIT_REPO=/git-repo
      - SPRING_PROFILES_ACTIVE=native
    mem_limit: 512M
    ports:
      - "8888:8888"

  discovery-server:
    image: springcommunity/spring-petclinic-discovery-server
    container_name: discovery-server
    mem_limit: 512M
    depends_on:
      - config-server
    entrypoint: ["./dockerize","-wait=tcp://config-server:8888","-timeout=60s","--","java", "org.springframework.boot.loader.JarLauncher"]
    ports:
      - "8761:8761"


  api-gateway:
    image: springcommunity/spring-petclinic-api-gateway
    container_name: api-gateway
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_ADMIN
    volumes:
      - ${SCRIPTPATH}/easeagent:/easeagent-volume
    entrypoint: 
      - "./dockerize"
      - "-wait=tcp://discovery-server:8761"
      - "-timeout=60s"
      - "--"
      - "java"
      - "$JAVA_AGENT_CONFIG"
      - "-javaagent:${JMX_AGENT_FILE}=9911:${JMX_AGENT_CONFIG}"
      - "-Deaseagent.config.path=/easeagent-volume/${EASEAGENT_CONFIG_FILE}"
      - "-Deaseagent.name=api-service"
      - "-Deaseagent.log.conf=/easeagent-volume/easeagent-log4j2.xml"
      - "-Deaseagent.server.port=9910"
      - "-Dspring.sleuth_enabled=false"
      - "-Dspring.sleuth.web.enabled=false"
      - "org.springframework.boot.loader.JarLauncher"
    ports:
      - "8080:8080"
      - "9910:9910"
      - "9911:9911"
    extra_hosts:
      - "tempo:${TEMPO_IP}"
      - "customers-service:${CUSTOMERS_IP}"
      - "vets-service:${VETS_IP}"
      - "visits-service:${VISITS_IP}"

